{% extends 'main.html' %}
{% load static %}
{% block content %}
<title>LMS- {{page_title}}</title>

<main>
    <section>
        <div class="container">
            <a href="{% url 'courses:course_list' %}">&laquo; Back to All Courses</a>
            <h1>{{course.titile}}</h1>

            <div class="course_info">
                {% if course.thumbnail %}
                <img src="{{course.thumbnail.url}}" alt="{{course.titile}}Thumbnail">
                {% else %}
                <img src="https://via.placeholder.com/250x180?text=No+Image" alt="No Thumbnail">
                {% endif %}

                <div class="course_info_text">
                    <p>{{course.description}}</p>
                    <div class="course_meta">
                        <span>Category: {{course.category.Name|default:"N/A"}}</span>
                        <span>Instructor: {{course.instructor.get_fullname|default:course.instructor.username}}</span>
                        <span>Price: {% if course.price > 0%}RS-{{course.price}}
                                    {% else %}Free{% endif %}
                        </span>
                        <span>Created: {{course.created_at|date:"M d,Y"}}</span>
                    </div>
                </div>
            </div>
            {% if request.user.is_authenticated and request.user.is_student %}
                {% if is_enrolled %}

                <div class="already_enrolled">You are already_enrolled in this COURSE!!!!!!.</div>

                {% else %}
                <form action="{% url 'enrollment:enroll_course' course.slug %}" method="post">{% csrf_token %}
                    <button type="submit" class="enroll_btn" >Enroll Now</button>
                </form>
                {% endif %}

            {% elif request.user.is_authenticated and request.user.is_instuctor %}
                <div class="already_enrolled">Instructor cannot enroll.</div>

            {% elif not request.user.is_authenticated %}
                <p>Please
                    <a href="{% url 'users:login' %}">login</a>as a student to enroll.
                </p>
            {% endif %}

            <h2>Course Content</h2>

            {% if course.instructor == request.user %}
                <p><a href="{% url 'courses:module_create' course.slug %}">Add New Module</a></p>
            {% endif %}

            {% if modules %}
            {% for module in modules %}
            <div class="module_item">
                <h3>Module {{module.order}}: {{module.title}}</h3>
                
                <p>{{module.description}}</p>

                {% if course.instructor == request.user %}
                    <p>
                        <a href="{% url 'courses:module_update' course.slug module.slug %}">Edit</a>
                        <a href="{% url 'courses:module_delete' course.slug module.slug %}">delete</a>

                        <a href="{% url 'courses:lesson_create' course.slug module.slug %}">Add New Lesson</a>
                    </p>
                {% endif %}

                {% if module.lesson.all %}
                <h4>Lessons: </h4>
                <ul>
                    {% for lesson in module.lesson.all %}
                    <li class="lesson_item">
                        <a href="{% url 'courses:lesson_details' course.slug module.slug lesson.slug %}">
                            {{lesson.order}}, {{lesson.title}} 
                            ({{lesson.get_content_type_display}})
                        </a>

                        {% if course.instructor == request.user %}
                            <p>
                                <a href="{% url 'courses:lesson_update' course.slug module.slug lesson.slug%}">Edit</a>
                                <a href="{% url 'courses:lesson_delete' course.slug module.slug lesson.slug%}">delete</a>
                            </p>
                        {% endif %}

                        {% if lesson.content_type == 'quiz' %}
                        (Quiz)
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No lessons in this Module yet.</p>
                {% endif %}
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </section>
</main>

{% endblock content %}